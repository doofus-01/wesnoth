#textdomain wesnoth-multiplayer

[multiplayer]
    id=multiplayer_test_Elevation_Demo
    name= _ "3p - Elevation Test"
    description= _ "This map is an example of how to use the new (BfW v1.17) elevated terrain graphics. Please be advised that it is not intended for playing."
    map_file=multiplayer/maps/3p_Elevation_Example.map

    {DEFAULT_SCHEDULE}
    {DEFAULT_MUSIC_PLAYLIST}

    [side]
        [leader]
            type=Orcish Warlord
            id=Orc1
        [/leader]
        faction=Northerners
        faction_lock=yes
        leader_lock=yes
        [ai]
            villages_per_scout=12
        [/ai]
        side=1
        canrecruit=yes
        controller=human
        team_name=southwest
        user_team_name= _ "teamname^Southwest"
        fog=yes
    [/side]
    [side]
        [leader]
            type=Lieutenant
            id=Loyal1
        [/leader]
        faction=Loyalists
        faction_lock=yes
        leader_lock=yes
        [ai]
            villages_per_scout=12
        [/ai]
        side=2
        canrecruit=yes
        controller=human
        team_name=defenders
        user_team_name= _ "teamname^Defenders"
        fog=yes
    [/side]
    [side]
        [leader]
            type=Dark Sorcerer
            id=Necro1
        [/leader]
        faction=Undead
        faction_lock=yes
        leader_lock=yes
        [ai]
            villages_per_scout=12
        [/ai]
        side=3
        canrecruit=yes
        controller=human
        team_name=southeast
        user_team_name= _ "teamname^Southeast"
        fog=yes
    [/side]

    [event]
        name=start
        [message]
            speaker=narrator
            message = _ "Should we try to determine the map elevation data with [elevation_score_map]?  You can turn off the labels by unchecking the 'Elevation' option in the Actions-> Show/Hide Labels menu."
            [option]
                message = _ "Yes!  I want to try this on this example map."
                [command]
                    [print]
                        text = "Checking for elevation data, this may take a few moments..."
                        size = 18
                        color = 200,200,255
                    [/print]
                    [delay]
                        time = 500
                    [/delay]
                    [redraw]
                        side=0
                    [/redraw]
                    [elevation_score_map]
                    [/elevation_score_map]
                [/command]
            [/option]
            [option]
                message = _ "Yes, but I want to test a broken map..."
                [command]
                    [print]
                        text = "Checking for elevation data, this may take a while..."
                        size = 18
                        color = 200,200,255
                    [/print]
                    [terrain]
                        terrain=Gg
                        x,y=39,22
                    [/terrain]
                    [terrain]
                        terrain=Gg
                        x,y=6-7,15
                    [/terrain]
                    [delay]
                        time = 500
                    [/delay]
                    [redraw]
                        side=0
                    [/redraw]
                    [elevation_score_map]
                        test_labels = true
                    [/elevation_score_map]
                [/command]
            [/option]
            [option]
                message = _ "No, I cannot risk it, let's just stick with cosmetic elevation."
            [/option]
        [/message]
    [/event]

#define TET_ELEVATION_UNIT_DATA TYPE BONUS

    [set_variable]
        name=x_hexes
        literal=""
    [/set_variable]
    [set_variable]
        name=y_hexes
        literal=""
    [/set_variable]
    [foreach]
        array=elevation_area
        [do]
            [if]
                [variable]
                    name=elevation_area[$i].type
                    equals={TYPE}
                [/variable]
                [then]
                    [set_variable]
                        name=x_hexes
                        value="$x_hexes|" + "$elevation_area[$i|].x|"
                    [/set_variable]
                    [set_variable]
                        name=y_hexes
                        value="$y_hexes|" + "$elevation_area[$i|].y|"
                    [/set_variable]
                    [event]
                        name=moveto
                        first_time_only=no
                        delayed_variable_substitution=no
                        [filter]
                            #            {UNIT_FILTER}
                            [filter_location]
                                x = $x_hexes|
                                y = $y_hexes|
                            [/filter_location]
                        [/filter]
                        [store_unit]
                            [filter]
                                id=$|unit.id
                            [/filter]
                            kill=no
                            variable=UNIT_AREA_TEMP
                        [/store_unit]
                        [set_variable]
                            name=UNIT_AREA_TEMP.variables.elevation
                            value={BONUS}
                        [/set_variable]
                        [unstore_unit]
                            variable=UNIT_AREA_TEMP
                            find_vacant=no
                        [/unstore_unit]
                        {CLEAR_VARIABLE UNIT_AREA_TEMP}
                    [/event]
                [/then]
            [/if]
        [/do]
    [/foreach]

#enddef

    [event]
        name=side 1 turn 1
        {TET_ELEVATION_UNIT_DATA high_high 2}
        {TET_ELEVATION_UNIT_DATA high 1}
        {TET_ELEVATION_UNIT_DATA elevation_default 0}
        {TET_ELEVATION_UNIT_DATA low -1}
        {TET_ELEVATION_UNIT_DATA low_low -2}
    [/event]

#undef TET_ELEVATION_UNIT_DATA

    # example usage of elevation by units
    [event]
        name=attack
        [filter_condition]
            [variable]
                name=unit.variables.elevation
                greater_than=$second_unit.variables.elevation
            [/variable]
        [/filter_condition]
        [message]
            speaker=unit
            message=_"I have the high ground!"
        [/message]
    [/event]

    [event]
        name=attack
        first_time_only=no
        [filter_condition]
            [variable]
                name=unit.variables.elevation
                greater_than=$second_unit.variables.elevation
            [/variable]
        [/filter_condition]
        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]
            [effect]
                apply_to=attack
                increase_damage=2
            [/effect]
        [/modify_unit]
        [event]
            name=attack_end
            first_time_only=no
            [filter_condition]
                [variable]
                    name=unit.variables.elevation
                    greater_than=$second_unit.variables.elevation
                [/variable]
            [/filter_condition]
            [modify_unit]
                [filter]
                    id=$unit.id
                [/filter]
                [effect]
                    apply_to=attack
                    increase_damage=-2
                [/effect]
            [/modify_unit]
        [/event]
    [/event]
[/multiplayer]
