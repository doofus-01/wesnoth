#textdomain wesnoth-sof

######################################################
# Assuming this is working correctly, all the campaign
# author needs to use is something like this:
# {SOF_MINECART_MENU cart1 5 12}
######################################################

#define SOF_MINECART_PLACE_IMAGE X Y

[if]
    [have_location]
        terrain=*^Br/
        x,y={X},{Y}
    [/have_location]
    [then]
        [item]
            image=misc/mine-cart-ne.png
            x,y={X},{Y}
        [/item]
    [/then]
    [elseif]
        [have_location]
            terrain=*^Br\
            x,y={X},{Y}
        [/have_location]
        [then]
            [item]
                image=misc/mine-cart-ne.png~FL(horiz)
                x,y={X},{Y}
            [/item]
        [/then]
    [/elseif]
    [else]
        [item]
            image=misc/mine-cart-n.png
            x,y={X},{Y}
        [/item]
    [/else]
[/if]            

#enddef

#define SOF_OBJ_MINECART VAR
[object]
    silent=yes
    id=sof_mine_cart_{VAR}
    take_only_once=no
    [filter]
        id=${VAR}.id
        race=dwarf
    [/filter]
    [effect]
        apply_to=new_animation
        [standing_anim]
            start_time=0
            terrain_type=*^Br*
            [if]
                terrain_type=*^Br|
                [frame]
                    image=misc/mine-cart-n.png~BLIT(${VAR}.image|~MASK(misc/mine-cart-mask-n.png,0,0),0,0):100
                    auto_hflip=no
                    auto_vflip=no
                [/frame]
            [/if]
            [else]
                terrain_type=*^Br\
                [frame]
                    image=misc/mine-cart-ne.png~BLIT(${VAR}.image|~MASK(misc/mine-cart-mask-ne.png,0,0),0,0)~FL(horiz):100
                    auto_hflip=no
                    auto_vflip=no
                [/frame]
            [/else]
            [else]
                terrain_type=*^Br/
                [frame]
                    image=misc/mine-cart-ne.png~BLIT(${VAR}.image|~MASK(misc/mine-cart-mask-ne.png,0,0),0,0):100
                    auto_hflip=no
                    auto_vflip=no
                [/frame]
            [/else]
        [/standing_anim]
    [/effect]
    [effect]
        apply_to=new_animation
        [movement_anim]
            start_time=0
            terrain_type=*^Br*
            [if]
                terrain_type=*^Br|
                [frame]
                    image=misc/mine-cart-n.png~BLIT(${VAR}.image|~MASK(misc/mine-cart-mask-n.png,0,0),0,0):200
                    auto_hflip=no
                    auto_vflip=no
                [/frame]
            [/if]
            [else]
                terrain_type=*^Br\
                [frame]
                    image=misc/mine-cart-ne.png~BLIT(${VAR}.image|~MASK(misc/mine-cart-mask-ne.png,0,0),0,0)~FL(horiz):200
                    auto_hflip=no
                    auto_vflip=no
                [/frame]
            [/else]
            [else]
                terrain_type=*^Br/
                [frame]
                    image=misc/mine-cart-ne.png~BLIT(${VAR}.image|~MASK(misc/mine-cart-mask-ne.png,0,0),0,0):200
                    auto_hflip=no
                    auto_vflip=no
                [/frame]
            [/else]
        [/movement_anim]
    [/effect]
    [effect]
        apply_to=movement
        increase=5
    [/effect]
    [effect]
        apply_to=movement_costs
        replace=yes
        [movement_costs]
            shallow_water=99
            reef=99
            swamp_water=99
            flat=99
            sand=99
            forest=99
            hills=99
            mountains=99
            village=99
            castle=99
            cave=99
            frozen=99
            fungus=99
            unwalkable=99
            impassable=99
            rails=1
        [/movement_costs]
    [/effect]
    [then]
        # it's one of these
        [remove_item]
            image=misc/mine-cart-n.png
            x,y=${VAR}.x|,${VAR}.y|
        [/remove_item]
        [remove_item]
            image=misc/mine-cart-ne.png
            x,y=${VAR}.x|,${VAR}.y|
        [/remove_item]
        [remove_item]
            image=misc/mine-cart-ne.png~FL(horiz)
            x,y=${VAR}.x|,${VAR}.y|
        [/remove_item]
    [/then]
[/object]
    
#enddef

#define SOF_REMOVE_OBJ_MINECART VAR
[remove_object]
    id=${VAR}.id
    object_id=sof_mine_cart_{VAR}
[/remove_object]

#enddef

#define SOF_MINECART_MENU VAR X Y

{SOF_MINECART_PLACE_IMAGE {X} {Y}}
[set_variables]
    name={VAR}
    mode=replace
    [value]
        load="empty"
        x={X}
        y={Y}
    [/value]
[/set_variables] 

[set_menu_item]
    id=sof_minecart_boarding_{VAR}
    description= _ "Board Cart"
    image=buttons/WML-custom.png
    [show_if]
        [variable]
            name={VAR}.load
            equals=empty
        [/variable]
        [variable]
            name={VAR}.x
            equals=$x1
        [/variable]
        [variable]
            name={VAR}.y
            equals=$y1
        [/variable]
        [have_unit]
            x,y=${VAR}.x|,${VAR}.y|
            race=dwarf
        [/have_unit]
    [/show_if]
    [filter_location]
        terrain=*^Br*
    [/filter_location]
    [command]
        [store_unit]
            [filter]
                x,y=${VAR}.x|,${VAR}.y|
            [/filter]
            variable=passenger_{VAR}
            kill=no
        [/store_unit]
        [set_variable]
            name={VAR}.load
            value=$passenger_{VAR}.id
        [/set_variable]
        {SOF_OBJ_MINECART passenger_{VAR}}
        # this is needed for graphics reasons, not just the movement
        [store_unit]
            [filter]
                x,y=${VAR}.x|,${VAR}.y|
            [/filter]
            variable=passenger_redraw
            kill=no
        [/store_unit]
        [set_variable]
            name=passenger_redraw.moves
            add=5
        [/set_variable]
        [unstore_unit]
            variable=passenger_redraw
            find_vacant=no
        [/unstore_unit]
        {CLEAR_VARIABLE passenger_redraw}
        [redraw]
            side=1
        [/redraw]
    [/command]
[/set_menu_item]
[set_menu_item]
    id=sof_minecart_unboarding_{VAR}
    description= _ "Leave Cart"
    image=buttons/WML-custom.png
    [show_if]
        [have_unit]
            x,y=$x1|,$y1|
            id=${VAR}.load
        [/have_unit]
    [/show_if]
    [filter_location]
        terrain=*^Br*
    [/filter_location]
    [command]
        [set_variable]
            name={VAR}.load
            value="empty"
        [/set_variable]
        [set_variable]
            name={VAR}.x
            value=$x1
        [/set_variable]
        [set_variable]
            name={VAR}.y
            value=$y1
        [/set_variable]
        {SOF_REMOVE_OBJ_MINECART passenger_{VAR}}
        [store_unit]
            [filter]
                x,y=${VAR}.x|,${VAR}.y|
            [/filter]
            variable=passenger_redraw
            kill=no
        [/store_unit]
        [set_variable]
            name=passenger_redraw.moves
            value=2
        [/set_variable]
        [unstore_unit]
            variable=passenger_redraw
            find_vacant=no
        [/unstore_unit]
        {CLEAR_VARIABLE passenger_redraw}
        {SOF_MINECART_PLACE_IMAGE $x1 $y1}
        {CLEAR_VARIABLE passenger_{VAR}}
    [/command]
[/set_menu_item]

[event]
    name=scenario_end
    {SOF_REMOVE_OBJ_MINECART passenger_{VAR}}
    {CLEAR_VARIABLE passenger_{VAR}}
[/event]



#enddef
