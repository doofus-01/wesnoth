#textdomain wesnoth-sof

#define SOF_RUNIC_OPTION ID NAME DESC ICON COST EFFECT_WML
                        image={ICON}
                        label= {NAME} + " <span style='italic'> ({COST}g)</span>"
                        description = {DESC}
                        [command]
                            [if]
                                [variable]
                                    name=unit.variables.{ID}_rune
                                    equals=yes
                                [/variable]
                                [then]
                                    [message]
                                        speaker=unit
                                        message=_"I already have this one..."
                                    [/message]
                                [/then]
                                [else]
                                    [set_variable]
                                        name=unit.variables.{ID}_rune
                                        value=yes
                                    [/set_variable]
                                    [unstore_unit]
                                        variable=unit
                                        find_vacant=no
                                    [/unstore_unit]
                                    [gold]
                                        side=1
                                        amount=-{COST}
                                    [/gold]
                                    [object]
                                        silent=yes
                                        duration=scenario
                                        [filter]
                                            id=$unit.id
                                        [/filter]
                                        {EFFECT_WML}
                                    [/object]
                                [/else]
                            [/if]
                        [/command]
#enddef


# thursagan moves to keep, or starts side turn at a keep, then
# adjacent units are stored and player can choose which one gets a rune

#define SOF_RUNIC_EVENTS
[event]
    name=moveto
    id=sof_sfe_moveto
    first_time_only=no
    [filter]
        id=Thursagan
        [filter_location]
            terrain=K*
        [/filter_location]
    [/filter]
    [store_unit]
        [filter]
            side=1
            race=dwarf
            [filter_adjacent]
                id=Thursagan
            [/filter_adjacent]
        [/filter]
        variable=rune_customer
        kill=no
    [/store_unit]
    [fire_event]
        id=sof_rune_shop
    [/fire_event]
[/event]
[event]
    name=side 1 turn
    id=sof_sfe_side1turn
    first_time_only=no
    [filter_condition]
        [have_unit]
            id=Thursagan
            [filter_location]
                terrain=K*
            [/filter_location]
        [/have_unit]
    [/filter_condition]
    [store_unit]
        [filter]
            side=1
            race=dwarf
            [filter_adjacent]
                id=Thursagan
            [/filter_adjacent]
        [/filter]
        variable=rune_customer
        kill=no
    [/store_unit]
    [fire_event]
        id=sof_rune_shop
    [/fire_event]
[/event]
[event]
    name=exit_hex
    id=sof_thursagan_exithex
    first_time_only=no
        [filter]
            id=Thursagan
            [filter_location]
                terrain=K*
            [/filter_location]
        [/filter]
        [remove_item]
            halo="scenery/summoning-circle[4,5,6].png:[250,250,250]"
            x,y=$x1|,$y1|
            radius=1
        [/remove_item]
        {CLEAR_VARIABLE rune_customer}
[/event]
[event]
    name=exit_hex
    id=sof_sfe_exithex
    first_time_only=no
    [filter]
        side=1
        race=dwarf
        [filter_adjacent]
            id=Thursagan
            [filter_location]
                terrain=K*
            [/filter_location]
        [/filter_adjacent]
    [/filter]
    [remove_item]      
        halo="scenery/summoning-circle[4,5,6].png:[250,250,250]"
        x,y=$x1|,$y1|
    [/remove_item]
    [store_unit]
        [filter]
            id=$unit.id
        [/filter]
        variable=ex_rune_customer
        kill=no
    [/store_unit]
    [foreach]
        array=rune_customer
        readonly=yes
        [do]
            [if]
                [variable]
                    name=ex_rune_customer.id
                    equals=$this_item.id
                [/variable]
                [then]
                    [set_variable]
                        name=index_TEMP
                        value=$i|
                    [/set_variable]
                [/then]
            [/if]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE rune_customer[$index_TEMP]}
    {CLEAR_VARIABLE ex_rune_customer}
    {CLEAR_VARIABLE index_TEMP}
[/event]
[event]
    name=moveto
    id=sof_sfe_2moveto
    first_time_only=no
    [filter]
        side=1
        race=dwarf
        [filter_adjacent]
            id=Thursagan
            [filter_location]
                terrain=K*
            [/filter_location]
        [/filter_adjacent]
    [/filter]
    [store_unit]
        [filter]
            id=$unit.id
        [/filter]
        variable=rune_customer
        kill=no
        mode=append
    [/store_unit]
    [fire_event]
        id=sof_rune_shop
    [/fire_event]
[/event]



[event]
    id=sof_rune_shop
    name=sof_rune_shop
    first_time_only=no
        [remove_item]
            halo="scenery/summoning-circle[4,5,6].png:[250,250,250]"
            [and]
                terrain=K*
                [filter]
                    id=Thursagan
                [/filter]
            [/and]
            radius=1
        [/remove_item]
        {CLEAR_VARIABLE abort_select_id}
    [foreach]
        array=rune_customer
        readonly=yes
        [do]
            [if]
                [variable]
                    name=this_item.variables.no_rune
                    equals=yes
                [/variable]
                [else]
                    [item]
                        halo="scenery/summoning-circle[4,5,6].png:[250,250,250]"
                        x,y=$this_item.x|,$this_item.y|
                    [/item]
                [/else]
            [/if]
        [/do]
    [/foreach]
            [event]
                name=select
                id=rc_select
                first_time_only=no
                [filter_condition]
                    [not]
                        [variable]
                            name=unit.variables.no_rune
                            equals=yes
                        [/variable]
                    [/not]
                [/filter_condition]
                [filter]
                    find_in=rune_customer
                [/filter]
                [message]
                    speaker=Thursagan
                    message= _ "I can hammer out a quick little runic charm, it should help you somewhat.  This isn't the place to do really good work though, so the effects will vanish in the future.  What do you say, is it worth a bit of gold and crystal?"
                    [option]
                        default=yes
                        image=attacks/blank-attack.png~BLIT(icons/unit-groups/cross_30.png~SCALE(60,60),0,0)
                        label= _ "Exit"
                        description = _ "Nothing for now"
                        [command]
                        [/command]
                    [/option]
                    [option]
                        default=yes
                        image=attacks/blank-attack.png~BLIT(icons/unit-groups/cross_30.png~BLEND(200,0,0,1.0)~SCALE(60,60),0,0)
                        label= _ "Reject"
                        description = _ "No thanks, don't ask again."
                        [command]
                            [set_variable]
                                name=unit.variables.no_rune
                                value=yes
                            [/set_variable]
                            [unstore_unit]
                                variable=unit
                                find_vacant=no
                            [/unstore_unit]
                            [remove_item]      
                                halo="scenery/summoning-circle[4,5,6].png:[250,250,250]"
                                x,y=$x1|,$y1|
                            [/remove_item]
                        [/command]
                    [/option]
                    [option]
                        {SOF_RUNIC_OPTION swiftness (_ "Swiftness") (_ "Adds 2 MP") ("misc/rune_icon.png~BLIT(scenery/summoning-circle4.png~CROP(6,6,60,60),0,0)") 13 (
                                        [effect]
                                            apply_to=movement
                                            increase=2
                                        [/effect]
                        )}
                    [/option]
                    [option]
                        {SOF_RUNIC_OPTION accuracy (_ "Accuracy") (_ "Increases ranged weapon accuracy 20%") ("misc/rune_icon.png~BLIT(scenery/summoning-circle5.png~CROP(6,6,60,60),0,0)") 16 (
                                        [effect]
                                            apply_to=attack
                                            range=ranged
                                            increase_accuracy=20
                                        [/effect]
                        )}
                    [/option]
                    [option]
                        {SOF_RUNIC_OPTION "force" (_ "Force") (_ "Increases melee weapon damage by 4") ("misc/rune_icon.png~BLIT(scenery/summoning-circle6.png~CROP(6,6,60,60),0,0)") 14 (
                                        [effect]
                                            apply_to=attack
                                            range=melee
                                            increase_damage=4
                                        [/effect]
                        )}
                    [/option]
                [/message]
            [/event]
[/event]

#enddef
